<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>CanberraAir</title>
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
      integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh"
      crossorigin="anonymous"
    />

    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="manifest" href="/site.webmanifest" />

    <style>
      .strike {
        text-decoration: line-through;
      }

      .report-line {
        border-bottom: 1px dotted black;
        /* display: inline-block; */
        margin-bottom: 5px;
        border-left: 5px solid;
        padding-left: 3px;
      }

      .report-line.hazardous {
        border-left-color: red;
      }

      .report-line.good {
        border-left-color: #274e13;
      }

      .report-line.very-good {
        border-left-color: #3d85c6;
      }

      .report-line.fair {
        border-left-color: #f1c232;
      }

      .report-line.poor {
        border-left-color: #e59137;
      }

      .report-line.very-poor {
        border-left-color: #a64d79;
      }

      .report-line.notice {
        border-left-color: lightblue;
      }

      .report-line.dark-notice {
        border-left-color: #7272ff;
      }

      .improving > .rating::after {
        content: " improving";
        font-size: 0.8em;
        font-weight: bold;
        color: lightblue;
      }

      .worsening > .rating::after {
        content: " worsening";
        font-size: 0.8em;
        font-weight: bold;
        color: orange;
      }

      span.worsening {
        font-weight: bold;
        color: orange;
      }

      span.improving {
        font-weight: bold;
        color: lightblue;
      }

      .rating {
        font-weight: bold;
      }

      .hazardous.rating,
      .hazardous .rating {
        color: red;
      }

      .good.rating,
      .good .rating {
        color: #274e13;
      }

      .very-good.rating,
      .very-good .rating {
        color: #3d85c6;
      }

      .fair.rating,
      .fair .rating {
        color: #f1c232;
      }

      .poor.rating,
      .poor .rating {
        color: #e59137;
      }

      .very-poor.rating,
      .very-poor .rating {
        color: #a64d79;
      }

      .air-report {
        width: 450px;
      }

      .air-report > h3 {
        margin-left: -3px;
      }

      .forecast h4,
      .current-status h4 {
        margin-bottom: 5px;
        margin-left: -2px;
        /* text-decoration: underline; */
        border-bottom: 1px solid black;
      }

      span.time-ago {
        color: gray;
        font-weight: normal;
        font-size: 0.7em;
      }

      .real-time {
        font-size: 0.8em;
      }

      .aqi-descriptions > div {
        display: inline-block;
        margin-right: 10px;
      }

      .aqi-desc-block {
        display: inline-block;
        line-height: 1em;
        font-size: 0.8em;
      }

      blockquote {
        border-left: 5px solid #cacaca;
        padding-left: 10px;
        background: #efefef;
      }

      dt > a {
        color: black;
      }

      dt > a:hover {
        color: black;
        text-decoration: underline dotted;
      }

      dd {
        margin-left: 5px;
      }

      iframe {
        border: 0px;
      }

      .graph-links {
        font-size: 0.7em;
      }

      .graph-selected {
        text-decoration: underline;
      }

      .google-visualization-tooltip {
        width: min-content !important;
        height: min-content !important;
      }

      .google-visualization-tooltip-item-list {
        margin: 0.5em 0 0.5em 0;
      }

      .google-visualization-tooltip-item {
        white-space: nowrap;
        margin: 0;
      }

      .google-visualization-tooltip-square {
        width: 1em;
        height: 1em;
        vertical-align: middle;
        margin: 0;
      }

      .google-visualization-tooltip-item-list
        .google-visualization-tooltip-item:first-child {
        margin: 0.5em 0em 0.5em 0em;
      }

      #customize-real-time > ol,
      #customize-real-time > ul {
        margin-bottom: 0.1rem;
      }

      #customize-real-time > ul {
        list-style: none;
      }

      #customize-real-time > button {
        margin: 1rem 0rem 1rem 2rem;
      }

      #customize-real-time label {
        margin-bottom: 0;
        cursor: pointer;
      }

      #customize-real-time li {
        cursor: pointer;
      }
    </style>
  </head>
  <body onLoad="">
    <div class="container-fluid">
      <h1>Bushfire Air Quality <span class="time-ago">ACT & Canberra</span></h1>
      <p>
        <a href="#current-aq">Current Air Quality</a> |
        <a href="#faq">Air Quality FAQ</a> | <a href="#news">News</a> |
        <a href="#useful-links">Useful Links</a> |
        <a href="#contact">Contact</a>
      </p>

      <div id="current-aq" class="row">
        <div class="col-md-6">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">
                Current Air Quality
                <span class="time-ago"
                  >hourly, last update: <span id="last-update"></span>, next
                  update: <span id="next-update"></span
                ></span>
              </h5>
              <div class="current-status">
                <div id="Florey-report" class="report-line">
                  North ACT (Florey): <span class="rating">Loading...</span>
                </div>
                <div id="Civic-report" class="report-line">
                  Centre Canberra (Civic):
                  <span class="rating">Loading...</span>
                </div>
                <div id="Monash-report" class="report-line">
                  South ACT (Monash): <span class="rating">Loading...</span>
                </div>
              </div>
              <cite style="font-size: 0.8em;"
                >Accurate hourly data courtesy of the wonderful
                <a href="https://airrater.org/">AirRater.org</a> API and
                app.</cite
              >

              <h5 style="margin-top:5px;">
                Near Real-Time
                <button
                  class="btn btn-info btn-sm"
                  style="padding: 0.05rem 0.5rem; float:right;"
                  onclick="PurpleAirCustomizer.show_customize_ui()"
                >
                  Customize
                </button>
                <span class="time-ago"
                  >updated: <span id="real-time-last-updated"></span
                ></span>
              </h5>
              <div style="margin-top:-9px; font-style: italic; font-size:0.8em">
                Note: <a href="#faq-real-time">real-time data</a> is not
                directly comparable with hourly data.
              </div>
              <div id="customize-real-time"></div>

              <div id="purple-air-sensors">Loading...</div>
              <!-- <div id="46225-report" class="report-line real-time">
                N. Cbr:
                <span class="real-time-line">Loading...</span>
              </div>
              
              <div id="41449-report" class="report-line real-time">
                Tuggers: <span class="real-time-line">Loading...</span>
              </div> -->

              <cite style="font-size: 0.8em;"
                >Real time data comes from
                <a
                  href="https://www.purpleair.com/map?opt=1/mPM25/a0/cC0#9.71/-35.3231/149.0494"
                  >PurpleAir monitoring stations</a
                >. See <a href="#faq-contributing-aqi">FAQ</a> to add your own.
              </cite>
            </div>
          </div>
        </div>

        <div id="news" class="col-md-6">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">Latest News</h5>

              <div class="report-line notice">
                <b>Beta test</b> of customizable real-time PurpleAir data!
                (Click the "Customize button").
                <span class="time-ago">Mon, Jan 28 11am</span>
              </div>

              <!-- <div class="report-line poor">
                Site is currently set up <em>only</em> for the PM2.5 particles caused
                by bushfire smoke. Do not use these ratings for the PM10 dust particles
                caused by the current dust storm. (I will add in PM10 reports soon.)
                <span class="time-ago">Thu, Jan 23 12:45pm</span>
              </div> -->

              <div class="report-line notice">
                Real-time updates added, courtesy of
                <a
                  href="https://www.purpleair.com/map?opt=1/mPM25/a0/cC0#9.71/-35.3231/149.0494"
                  >PurpleAir</a
                >
                <span class="time-ago">Sun, Jan 13 12pm</span>
              </div>

              <div class="report-line notice">
                Site code available on
                <a href="https://github.com/CanberraAir/CanberraAir.com"
                  >Github</a
                >. Additions welcome.
                <span class="time-ago">Fri, Jan 10 5pm</span>
              </div>

              <div class="report-line dark-notice">
                The ACT Health folks have released
                <a
                  href="https://www.health.act.gov.au/about-our-health-system/population-health/environmental-monitoring/monitoring-and-regulating-air-7"
                  >a prototype real hourly data graph.</a
                >
                Great job guys!
                <span class="time-ago">Thu, Jan 09 2pm</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div id="graphs" class="row">
        <div class="col-md-6">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">
                Graphs
                <span class="graph-links"
                  ><a
                    href="#graphs"
                    onclick="return graphHours(6, this)"
                    class="graph-selected"
                    >6hr</a
                  >
                  |
                  <a
                    href="#graphs"
                    onclick="return graphHours(12, this)"
                    >12hr</a
                  >
                  |
                  <a
                    href="#graphs"
                    onclick="return graphHours(24, this)"
                    >24hr</a
                  >
                </span>
              </h5>
              <!-- <div id="chart-header">tesxt</div> -->
              <div id="chart-div"></div>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">ACT Government Notices</h5>
              <ul>
                <li>
                  <a
                    href="https://esa.act.gov.au/total-fire-ban-friday-10-january-2020a"
                    >TOTAL FIRE BAN in Place Friday, Jan 10</a
                  >
                </li>
                <li>
                  <a href="https://esa.act.gov.au/state-alert-declared-act-0"
                    >State of Alert declared for ACT</a
                  >
                </li>
                <li>
                  <a href="https://esa.act.gov.au/update-hospital-hill-fire"
                    >Hospital Hill Fire under control (Patrol) - 07/01/2020</a
                  >
                </li>
                <li>
                  <a
                    href="https://health.act.gov.au/public-health-alert/heavy-smoke-and-hot-conditions-act"
                  >
                    Heavy smoke and hot conditions in the ACT.
                  </a>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>

      <div class="row">
        <div id="useful-links" class="col-md-6">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">Useful Links</h5>
              <ul>
                <li>
                  <a
                    href="https://www.rfs.nsw.gov.au/__data/assets/image/0017/161108/Potential-fire-spread-prediction-incl-embers-A0.png"
                    >Fire spread prediction map Fri, Jan 10</a
                  >
                  <span class="text-secondary">: NSW RFS predictions.</span>
                </li>
                <li>
                  <a
                    href="https://www.health.act.gov.au/about-our-health-system/population-health/environmental-monitoring/monitoring-and-regulating-air-7"
                  >
                    ACT Health PM2.5 - Hourly Data<span class="text-secondary"
                      >: Hourly and 24 hour PM2.5 concentrations.</span
                    >
                  </a>
                </li>
                <li>
                  <a
                    href="https://www.rfs.nsw.gov.au/fire-information/fires-near-me"
                    >NSW Fires Near Me Map</a
                  ><span class="text-secondary"
                    >: All fires in ACT/NSW, and current warning advice.</span
                  >
                </li>
                <li>
                  <a
                    href="https://www.facebook.com/groups/MyAirQualityAustralia/"
                    >My Air Quality Australia FB Group</a
                  ><span class="text-secondary"
                    >: Useful discussion, tips, Q&amp;A, home air quality.</span
                  >
                </li>
                <li>
                  <a href="https://www.facebook.com/nswrfs"
                    >NSW Fire Service FB Page</a
                  >
                  <span class="text-secondary"
                    >: Fire spread predictions and alerts.</span
                  >
                </li>
                <li>
                  <a
                    href="https://docs.google.com/forms/d/e/1FAIpQLScmxvF76_pX2dRu2GrdzAcPC-ilF80nSEIy-TzWSl0LL7CfQw/viewform"
                  >
                    Air Purifier Survey</a
                  ><span class="text-secondary"
                    >: Survey I'm running to get a sense of
                    availabilty+shortages.</span
                  >
                </li>

                <li>
                  <a href="https://myfirewatch.landgate.wa.gov.au"
                    >Australia Bushfire Map</a
                  ><span class="text-secondary"
                    >: Current location and spread of fires across
                    Australia</span
                  >
                </li>

                <li>
                  <a href="https://www.livetraffic.com">NSW Road Closures</a
                  ><span class="text-secondary"
                    >: Changes constantly, check before traveling.</span
                  >
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>

      <a id="faq"></a>
      <div class="row">
        <div class="col-sm">
          <h3>FAQ</h3>
          <h5>Basic Air Quality Info</h5>
          <dl>
            <dt>
              <a id="faq-aqi" href="#faq-aqi"
                >What is an AQI (Air Quality Index)?</a
              >
            </dt>
            <dd>
              <blockquote class="blockquote">
                <p class="mb-0">
                  The Air Quality Index (AQI) is a scale of air pollution that
                  gives Canberrans an indication of how clean the air is so we
                  can change our outdoor activities if pollution levels are
                  high.
                </p>
                <footer class="blockquote-footer">
                  <cite title="Source Title"
                    ><a
                      href="https://www.health.act.gov.au/about-our-health-system/population-health/environmental-monitoring/monitoring-and-regulating-air-2"
                      >ACT Health "Measuring air quality"</a
                    ></cite
                  >
                </footer>
              </blockquote>

              The AQI levels are as follows:<br />
              <div class="aqi-descriptions">
                <div>
                  <span class="aqi-desc-block">0-33<br />Very Good</span>
                  <span style="color: rgb(61, 133, 198); font-size: xx-large;"
                    >●</span
                  >
                </div>
                <div>
                  <span class="aqi-desc-block">34-66<br />Good</span>
                  <span style="color: rgb(39, 78, 19); font-size: xx-large;"
                    >●</span
                  >
                </div>
                <div>
                  <span class="aqi-desc-block">67-99<br />Fair</span>
                  <span style="color: rgb(241, 194, 50); font-size: xx-large;"
                    >●</span
                  >
                </div>
                <div>
                  <span class="aqi-desc-block">100-149<br />Poor</span>
                  <span style="color: rgb(230, 145, 56); font-size: xx-large;"
                    >●</span
                  >
                </div>
                <div>
                  <span class="aqi-desc-block">150-200<br />Very Poor</span>
                  <span style="color: rgb(166, 77, 121); font-size: xx-large;"
                    >●</span
                  >
                </div>
                <div>
                  <span class="aqi-desc-block">200+<br />Hazardous</span>
                  <span style="color: rgb(255, 0, 0); font-size: xx-large;"
                    >●</span
                  >
                </div>
              </div>
            </dd>

            <dt>
              <a id="faq-pm25" href="#faq-pm25">What are PM2.5 particles?</a>
            </dt>
            <dd>
              <p>
                A general term for any atmospheric particle smaller than 2.5
                micrometers (μm) in diameter (3% diameter of a human hair).
              </p>
              <p>
                <em>Bushfire smoke contains large amounts of PM2.5</em>. When
                reports say that "AQI is really high" or "Air quality is
                terrible", they're referring primarily to the high PM2.5
                concentration.
              </p>
              <p>
                An excellent further reading:
                <a href="https://blissair.com/what-is-pm-2-5.htm"
                  >What is PM2.5 and Why You Should Care</a
                >
              </p>
            </dd>

            <dt>
              <a id="faq-pm25-danger" href="#faq-pm25-danger"
                >Why are PM2.5 particles dangerous?</a
              >
            </dt>
            <dd>
              They contain all sorts of toxins, and are so small that they can
              penetrate deep into the blood stream and all your body's tissues.
              Unlike large particles, your body has a much harder time filtering
              these particles out. Consistent high levels of PM2.5 exposure have
              been linked to a large number of health conditions, including
              respiratory trouble, heart disease, depression, and cancer.
            </dd>

            <dt>
              <a id="faq-pm25-risk-groups" href="#faq-pm25-risk-groups"
                >Who is most at risk from PM2.5 particles?</a
              >
            </dt>
            <dd>
              Anyone with a respiratory condition, children, the elderly,
              pregnant women.
            </dd>

            <dt>
              <a id="faq-pm25-not-risk-group" href="#faq-pm25-not-risk-group">
                If I'm not in an "at risk" group, is it okay for me to breathe
                the smoke?</a
              >
            </dt>
            <dd>
              Absolutely not. Everyone is harmed by smoke pollution. Even if you
              don't have any immediate symptoms, prolonged expsoure can cause
              serious long-term health problems.
            </dd>

            <dt>
              <a id="faq-no-smell-smoke" href="#faq-no-smell-smoke">
                If I can't smell smoke, or the air looks clear, does that mean
                the air is safe?</a
              >
            </dt>
            <dd>
              Not necessarily. PM2.5 particles are so small that they are
              difficult to smell, or see in the air. I have measured hazardous
              levels of PM2.5 in buildings which look and smell clear.
            </dd>

            <dt>
              <a id="faq-aircon-building-safe" href="#faq-aircon-building-safe">
                If a building has their aircon on, does that mean the air is
                safe?</a
              >
            </dt>
            <dd>
              Again, not necessarily. Some aircon systems filter out larger
              (e.g. PM10) particles, and cooler air can often feel nicer. Unless
              their aircon has
              <a href="#faq-hepa-filter">the right kind of filter</a>, the
              building may still have toxic levels of PM2.5. (My local gym had
              this exact problem. People should not work out in such
              conditions.)
            </dd>

            <dt>
              <a id="faq-aqi-pm25" href="#faq-aqi-pm25">
                What is the relationship between AQI and PM2.5 concentration?</a
              >
            </dt>
            <dd>
              Air particles are measured in terms of "micrograms per cubic meter
              of air" (&micro;g/m<sup>3</sup>). In the ACT, AQI is calculated by
              multiplying the actual particle readings by 4. So a 50 ug/m<sup
                >3</sup
              >
              particle concentration would yield an AQI of 200 (Hazardous).
            </dd>

            <dt>
              <a id="faq-differing-aqi" href="#faq-differing-aqi">
                Why do other apps and site seemingly report different AQI
                numbers?</a
              >
            </dt>
            <dd>
              There are several reasons for this:
              <ol>
                <li>
                  Even though the actual particle concentration is the same,
                  different groups multiply this number by different amounts to
                  derive their AQI score. Because of this,
                  <em
                    >you can not compare AQI scores between apps or
                    organizations.</em
                  >
                  Instead you need to get that original PM2.5 concentration
                  number.
                </li>
                <li>
                  Many apps pull from the publicly available data on the
                  <a
                    href="https://www.health.act.gov.au/about-our-health-system/population-health/environmental-monitoring/monitoring-and-regulating-air"
                    >ACT Health Air Quality</a
                  >
                  page. This data is a 24-hour rolling average of PM2.5
                  readings, and does not reflect the very latest air quality
                  readings. It can take 12+ hours for the ACT Health numbers to
                  reflect the actual outdoor air quality.
                  <em
                    >Our numbers
                    <a href="#current-aq">at the top of this page</a> do not
                    have this problem, and are accurate to the latest hour.</em
                  >
                </li>
              </ol>
            </dd>

            <dt>
              <a id="faq-hourly-reporting" href="#faq-hourly-reporting"
                >Wait, but the ACT Health site says their numbers are from the
                last hour?</a
              >
            </dt>
            <dd>
              <p>
                I've had many folks write in to point this out. While they say
                their PM2.5 readings are hourly, they are actually the 24 hour
                rolling average. You can verify this yourself by multiplying
                their PM2.5 numbers by 4, and getting the exact "24 hour rolling
                average AQI" value (ie. PM2.5 * 4 = AQI_PM2.5). It took me quite
                a while to get the real hourly data. (I asked them directly, and
                they declined to publish it themselves.)
              </p>

              <p>
                <b>Update:</b> The ACT Health team has started publishing actual
                hourly numbers
                <a
                  href="https://www.health.act.gov.au/about-our-health-system/population-health/environmental-monitoring/monitoring-and-regulating-air-7"
                  >on this page.</a
                >
                The data are accurate, and timely.
              </p>
            </dd>

            <dt>
              <a id="faq-real-time" href="#faq-real-time"
                >How does your "real-time" data work?</a
              >
            </dt>
            <dd>
              We take data from
              <a
                href="https://www.purpleair.com/map?opt=1/mPM25/a0/cC0#9.71/-35.3231/149.0494"
                >PurpleAir</a
              >
              monitoring stations, which update in real time. Because these
              stations use many different kinds of sensors, the data from them
              are not directly comparable with the sensors used by ACT Health.
              They are, however, reasonably close, and can give you a rapid view
              on what the air quality is doing <em>right now</em>.
            </dd>
          </dl>

          <h5>Dealing With Poor Air</h5>
          <dl>
            <dt>
              <a id="faq-deal-with-smoke" href="#faq-deal-with-smoke"
                >How can I deal with the smoke?</a
              >
            </dt>
            <dd>
              In brief (see following questions)
              <ul>
                <li>Wear a mask outdoors.</li>
                <li>Avoid strenuous activity.</li>
                <li>Use an air purifier / filter inside.</li>
                <li>Seal your buildings to avoid smoke penetration.</li>
                <li>Monitor your own home's air quality.</li>
              </ul>
            </dd>

            <dt>
              <a id="faq-respirator" href="#faq-respirator"
                >What kind of mask do I need?</a
              >
            </dt>
            <dd>
              You need a mask rated for smoke particles. In Australia, this is
              listed as a <strong>P2 mask/respirator</strong>. For US products,
              these will be listed as "N95" or "P100" respirators. You will also
              need to ensure that the mask has a good, tight fit around yoru
              face. Read the package for instructions.
            </dd>

            <dt>
              <a id="faq-respirator-children" href="#faq-respirator"
                >Can children wear a respirator mask?</a
              >
            </dt>
            <dd></dd>

            <dt>
              <a id="faq-where-get-masks" href="#faq-where-get-masks"
                >Where can I get good masks?</a
              >
            </dt>
            <dd>
              Bunnings, or your local hardware store.
              <a
                href="https://www.bunnings.com.au/protector-flat-fold-disposable-respirator-20-pack_p5810077"
                >Here's an example at Bunnings.</a
              >
              There are also more permanent masks,
              <a href="https://www.vogmask.com/"
                >and even ones with cool colors and styles</a
              >
              for long term use. These may also be more comfortable.
            </dd>

            <dt>
              <a id="faq-air-purifier" href="#faq-air-purifier"
                >What is an air purifier?</a
              >
            </dt>
            <dd>
              A device with a fan which blows air through a filter, designed to
              remove pollution and toxic particles from the air.
            </dd>

            <dt>
              <a id="faq-hepa-filter" href="#faq-hepa-filter"
                >What kind of air purifier do I need for smoke?</a
              >
            </dt>
            <dd>
              You need one which has a "True
              <abbr title="High-efficiency particulate absorbing">HEPA</abbr>
              filter" (sometimes rated as E11, E12, E13, H11, H12, H13+).
              Without this kind of filter, the device will not remove PM2.5 from
              the air.
            </dd>

            <dt>
              <a id="faq-humidifier" href="#faq-humidifier"
                >Can a humidifer work to purify my air?</a
              >
            </dt>
            <dd>Maybe slightly, but it's not significant on its own.</dd>

            <dt>
              <a id="faq-air-purifier-power" href="#faq-air-purifier-power"
                >How powerful should my air purifier be?</a
              >
            </dt>
            <dd>
              <p>
                Air purifiers are rated by
                <abbr title="Clean Air Delivery Rate">CADR</abbr> (Clean Air
                Delivery Rate) or
                <abbr title="Cubic meters per hour">m<sup>3</sup>/h</abbr>
                (cubic meters per hours). These values are used together with
                the area/volume of your room to figure out how many times per
                hour the purifier filters all your air, a number often called
                the <abbr title="Air changes per hour">ACH</abbr> (Air Changes
                per Hour).
              </p>

              <p>
                You want your purifier to filter all the air in your room at
                least 3 times per hour, though 5+ times is ideal. I have created
                a simple
                <a href="air-purifier-calculator.html"
                  >Air Purifier Power Calculator</a
                >
                which can help you figure out what CADR (or m<sup>3</sup>/h)
                rating works best for your room/house.
              </p>
            </dd>

            <dt>
              <a id="faq-purifier-big-room" href="#faq-purifier-big-room"
                >What if my house/room is too big for my purifier?</a
              >
            </dt>
            <dd>
              Every little bit still helps. You may also want to move into a
              smaller, or more airtight room. The more airtight your house is,
              the more effective your purifier will be.
            </dd>

            <dt>
              <a id="faq-airtight-house" href="#faq-airtight-house"
                >How can I make my house more airtight?</a
              >
            </dt>
            <dd>
              <ul>
                <li>Close external vents and windows.</li>
                <li>Seal corners of window with masking tape.</li>
                <li>Cover areas of airflow with wet towels.</li>
              </ul>
            </dd>

            <dt>
              <a id="faq-no-purifier" href="#faq-no-purifier"
                >What if I don't have an air purifier?</a
              >
            </dt>
            <dd>
              <ul>
                <li>
                  If you have ducted heating, you can put your heater on FAN
                  ONLY setting. While most heating filters aren't
                  <a href="#faq-hepa-filter">HEPA rated</a>, they can still make
                  things a little better.
                </li>
                <li>
                  Wet towels: hang them in front of fans, over your ducted
                  heating (see above), etc. Blowing air through/over them will
                  filter out some of the smoke.
                </li>
                <li>
                  Run your stove rangehood fan – the carbon filter in there may
                  filter out some smoke.
                </li>
              </ul>
            </dd>

            <dt>
              <a id="faq-evaporative-cooler" href="#faq-evaporative-cooler"
                >Should I use an evaporative cooler during heavy smoke?</a
              >
            </dt>
            <dd>
              Evaporative coolers require open doors/windows, and are not
              recommended to use during smoke haze.
            </dd>

            <dt>
              <a id="faq-monitoring-aqi" href="#faq-monitoring-aqi"
                >How can I monitor my own home / environment's air quality?</a
              >
            </dt>
            <dd>
              <p>
                Consumer air quality monitors are nowhere near as accurate as
                lab equipment, but they can still be useful to get a sense of
                how bad it is, and to measure changes in conditions, such as
                when more smoke rolls in, or you've set up a new purifier in
                your home.
              </p>
              <p>
                I personally use the
                <a href="https://amzn.to/2ZVOmL5"
                  >Temtop M10 Air Quality Monitor</a
                >, and have found it to be convenient, portable, and accurate
                enough for personal use. When I turn on my purifier in my
                bedroom, for example, the numbers dropped from 600 (outside) to
                about 5 over the course of 25 minutes. (See
                <a
                  href="https://twitter.com/CanberraAir/status/1207585970154917895"
                  >this tweet</a
                >
                for an example, tracking incoming smoke.)
              </p>
            </dd>

            <dt>
              <a id="faq-aqi-app" href="#faq-aqi-app"
                >Can I get air quality data in an app?</a
              >
            </dt>
            <dd>
              Yes, the <a href="https://airrater.org">AirRater</a> app has
              hourly air quality readings. You can save your location and have
              the app notify you when the air starts getting bad.
            </dd>

            <dt>
              <a id="faq-contributing-aqi" href="#faq-contributing-aqi">
                Can I help with measuring air quality?
              </a>
            </dt>
            <dd>
              <p>
                Yes! The
                <a href="https://www2.purpleair.com">PurpleAir</a> service makes
                air quality sensors you can install around your home. Data from
                here shows up on their map in real-time, available to all. If
                folks all around the ACT did this, we could have accurate AQI
                numbers for the entire state!
              </p>

              <p>
                The <a href="https://aqicn.org/gaia/">Aqicn network</a> also has
                some good monitoring stations you can set up, though there
                aren't any running at present in the ACT, maybe you can be the
                first!
              </p>
            </dd>
          </dl>

          <h5>ACT Fire Status</h5>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col-md-6">
        <div id="contact" class="card">
          <div class="card-body">
            <h5 class="card-title">Contact</h5>
            Twitter: <a href="https://twitter.com/CanberraAir">@CanberraAir</a
            ><br />
            Email:
            <a href="mailto:canberra.air.quality@gmail.com"
              >canberra.air.quality@gmail.com</a
            ><br />
            Facebook:
            <a href="https://www.facebook.com/Canberra-Air-101646801348702/"
              >CanberraAir</a
            ><br />
            Github:
            <a href="https://github.com/CanberraAir/CanberraAir.com">
              CanberraAir</a
            >
            <p style="margin-top: 10px;">
              Please feel free to contact me with questions or comments. If
              you've thought of a way to help out during this crisis, I'm
              interested to hear about it!
            </p>
          </div>
        </div>
      </div>
    </div>

    <script>
      // --- NOTE TO ANYONE READING THIS CODE ---
      // Yes, I know it's a mess. This code was written for a need, for speed,
      // and may eventually (hopefully) be cleaned up... but we all know about
      // the best laid plans of 'roos and men...

      ACT_AQ_URL =
        "https://www.data.act.gov.au/api/id/rr3g-auih.json?$query=SELECT%20%60datetime%60%20AS%20thetime%2C%20%60name%60%20AS%20name%2C%20AVG%28%60aqi_pm2_5%60%29%20AS%20pm25%20WHERE%20%60datetime%60%20%3E%3D%20%272020-01-03%27%20AND%20%60datetime%60%20%3C%20%272020-01-04%27%20AND%20%28%20%60name%60%20%3D%20%27Monash%27%20OR%20%60name%60%20%3D%20%27Civic%27%20OR%20%60name%60%20%3D%20%27Florey%27%20%29%20AND%20%60datetime%60%20IN%20%28%20%272020-01-03T00%3A00%3A00.000%27%2C%20%272020-01-03T01%3A00%3A00.000%27%2C%20%272020-01-03T02%3A00%3A00.000%27%2C%20%272020-01-03T03%3A00%3A00.000%27%2C%20%272020-01-03T04%3A00%3A00.000%27%2C%20%272020-01-03T05%3A00%3A00.000%27%2C%20%272020-01-03T06%3A00%3A00.000%27%2C%20%272020-01-03T07%3A00%3A00.000%27%2C%20%272020-01-03T08%3A00%3A00.000%27%2C%20%272020-01-03T09%3A00%3A00.000%27%2C%20%272020-01-03T10%3A00%3A00.000%27%2C%20%272020-01-03T11%3A00%3A00.000%27%20%29%20AND%20%60name%60%20IN%20%28%27Civic%27%2C%20%27Florey%27%2C%20%27Monash%27%29%20GROUP%20BY%20%60datetime%60%2C%20name%20ORDER%20BY%20pm25%20DESC%20NULL%20LAST%20LIMIT%201001";

      AIRRATER_URL =
        "https://r.airrater.org/custom/q/q=?q=%7B%22Type%22:%22QueryDay%22,%22Lat%22:_LAT_,%22Lon%22:_LON_%7D";

      PURPLEAIR_SENSORS =
        "https://www.purpleair.com/data.json?opt=1/mPM25/a10/cC0&fetch=true&nwlat=-35.113366&selat=-35.906423&nwlng=148.894512&selng=149.603537&fields=ID,Label,Lat,Lon,Age";

      ACT_HEALTH_LOCS = {
        Monash: [-35.418302, 149.094018],
        Florey: [-35.220606, 149.043539],
        Civic: [-35.285307, 149.131579]
      };

      const COLORS = {
        Civic: "#636363",
        Florey: "#f8b2b8",
        Monash: "#71abd9"
      };

      const AN_HOUR = 60 * 60 * 1000,
        A_MINUTE = 60 * 1000;

      GOOGLE_LOADED = false;

      function draw_graphs() {
        if (!GOOGLE_LOADED) {
          setTimeout(draw_graphs, 100);
          return;
        }
        drawAQI();
      }

      PurpleAirCustomizer = {
        customize_el: document.getElementById("customize-real-time"),
        _selected_sensors_ids: [45629, 46223, 42391, 46225], // Light, Melba, Tugger, Watson
        _sensors: {},
        _cache_loaded: false,
        _on_update: () => {}, // to be replaced by PurpleAir object
        ui_displayed: false,

        set on_update(cbk) {
          this._on_update = cbk;
          this._on_update(this.selected_sensor_ids);
        },

        get on_update() {
          return this._on_update;
        },

        async initialize() {
          if (
            this.selected_sensor_ids.length > 0 &&
            Object.keys(this.sensors).length == 0
          )
            await this.fetch_active_sensors();
        },

        async show_customize_ui() {
          if (this.ui_displayed) {
            this.customize_el.innerHTML = "";
            this.ui_displayed = false;
            return;
          }

          this.ui_displayed = true;
          this.customize_el.innerHTML = this.generate_customize_instructions();
          let sensor_list_html = await this.generate_sensor_list_node();

          document
            .getElementById("loading-sensor-list")
            .replaceWith(sensor_list_html);

          let sensor_list = document.getElementById("customize-sensor-list");

          let update = document.createElement("button");
          update.innerHTML = "Update Sensors";
          update.classList.add("btn", "btn-primary", "btn-sm");
          update.onclick = () => this.on_update_sensors();

          sensor_list.parentNode.insertBefore(update, sensor_list.nextSibling);
        },

        generate_customize_instructions() {
          return `
             <b>Customize Instructions:</b>
             <ol style="margin-bottom: 0.1rem;">
               <li>Look at the <a href="https://www.purpleair.com/map?opt=1/mPM25/a0/cC0#9.71/-35.3231/149.0494">PurpleAir</a> map and click on each sensor you would like to add.</li>
               <li>Note the name of each sensor at the bottom of the popup (after you click).</li>
               <li>Select those sensors from the list below.</li>
             </ol>
             <span id="loading-sensor-list">Loading sensor list from PurpleAir...</span>
          `;
        },

        async generate_sensor_list_node() {
          let sensors = await this.fetch_active_sensors(),
            selected = new Set(this.selected_sensor_ids);

          let lis = sensors.map(s => {
            let checked = selected.has(s.id) ? " checked" : "";
            return `<li><label><input type="checkbox" value="${s.id}"${checked}/> ${s.label}</label></li>`;
          });

          let ul = document.createElement("ul");
          ul.id = "customize-sensor-list";
          ul.innerHTML = lis.join("\n");

          return ul;
        },

        async fetch_active_sensors() {
          let sensors = await fetch(PURPLEAIR_SENSORS)
            .then(r => r.json())
            .then(sensors => {
              let [id, age, lat, lon, type, label] = [
                sensors.fields.indexOf("ID"),
                sensors.fields.indexOf("age"),
                sensors.fields.indexOf("Lat"),
                sensors.fields.indexOf("Lon"),
                sensors.fields.indexOf("Type"),
                sensors.fields.indexOf("Label")
              ];

              return sensors.data
                .filter(n => n[lat] && n[age] < 30 && n[type] == 0) // outdoor
                .map(s => ({
                  id: s[id],
                  label: s[label],
                  lat: s[lat],
                  lon: s[lon]
                }))
                .sort((a, b) => a.label.localeCompare(b.label));
            });

          this.update_sensor_list(sensors);

          return sensors;
        },

        update_sensor_list(new_sensors) {
          let sensors = {};
          new_sensors.forEach(s => (sensors[s.id] = s));
          this._sensors = sensors;

          localStorage.purple_air_customized_sensors = JSON.stringify(
            this.sensors
          );

          return new_sensors;
        },

        load_cache() {
          if (localStorage.purple_air_selected_sensors)
            this._selected_sensors_ids = JSON.parse(
              localStorage.purple_air_selected_sensors
            );

          if (localStorage.purple_air_customized_sensors)
            this._sensors = JSON.parse(
              localStorage.purple_air_customized_sensors
            );

          this._cache_loaded = true;
        },

        get selected_sensor_ids() {
          if (!this._cache_loaded) this.load_cache();

          return this._selected_sensors_ids;
        },

        get sensors() {
          if (!this._cache_loaded) this.load_cache();

          return this._sensors;
        },

        on_update_sensors() {
          let selected_ids = [].slice
            .call(document.querySelectorAll("#customize-sensor-list input"))
            .filter(n => n.checked)
            .map(n => parseInt(n.value));

          this._selected_sensors_ids = selected_ids;
          localStorage.purple_air_selected_sensors = JSON.stringify(
            selected_ids
          );

          this.customize_el.innerHTML = "";

          this.on_update(selected_ids);
        }
      };

      PurpleAir = {
        api_url: "https://www.purpleair.com/json?show=",
        sensors: {
          // north_canberra: {
          //   id: 46225,
          //   last_updated: 0,
          //   raw_response: {},
          //   stats: {},
          //   enabled: true,
          //   label: "N. Cbr"
          // },
          // tuggeranong: {
          //   id: 41449,
          //   last_updated: 0,
          //   raw_response: {},
          //   stats: {},
          //   enabled: true,
          //   label: "Tuggers"
          // }
        },
        intialized: false,
        update_interval: 5 * A_MINUTE,

        async initialize() {
          this.load_from_cache();

          // let selected_sensors = PurpleAirCustomizer.selected_sensor_ids;
          // if (selected_sensors) this.update_enabled_sensors(selected_sensors);

          await PurpleAirCustomizer.initialize();
          PurpleAirCustomizer.on_update = selected_ids => {
            this.update_enabled_sensors(selected_ids);
            this.fetch_and_render_latest();
            this.periodic_update();
          };
        },

        get last_updated() {
          return Object.values(this.sensors)[0].last_updated;
        },

        update_enabled_sensors(sensor_ids) {
          let ids = new Set(sensor_ids),
            current_ids = new Set();

          for (let loc in this.sensors) {
            let s_id = this.sensors[loc].id;
            this.sensors[loc].enabled = ids.has(s_id);
            current_ids.add(s_id);
          }

          let new_ids = sensor_ids.filter(id => !current_ids.has(id));

          new_ids.forEach(id => {
            let sensor = PurpleAirCustomizer.sensors[id];
            this.sensors[sensor.label] = {
              last_updated: 0,
              raw_response: {},
              stats: {},
              enabled: true,
              ...sensor
            };
          });
        },

        async periodic_update() {
          if (this.cur_timeout) clearTimeout(this.cur_timeout);

          let since_last_update = new Date() - this.last_updated;

          let next_update;
          if (since_last_update >= this.update_interval) {
            await this.fetch_and_render_latest();
            next_update = this.update_interval;
          } else {
            this.render();
            next_update = this.update_interval - since_last_update;
          }

          this.cur_timeout = setTimeout(
            () => this.periodic_update(),
            next_update
          );
        },

        async fetch_and_render_latest() {
          for (let loc in this.sensors) {
            let data = await this.fetch_sensor_data(this.sensors[loc]);

            this.update_sensor_data(loc, data);
          }

          this.render();
        },

        async fetch_active_sensors() {
          fetch(PURPLEAIR_SENSORS)
            .then(r => r.json())
            .then(sensors => {
              let [id, age, lat, lon, type, label] = [
                sensors.fields.indexOf("ID"),
                sensors.fields.indexOf("age"),
                sensors.fields.indexOf("Lat"),
                sensors.fields.indexOf("Lon"),
                sensors.fields.indexOf("Type"),
                sensors.fields.indexOf("Label")
              ];

              return sensors.data
                .filter(n => n[lat] && n[age] < 30 && n[type] == 0) // outdoor
                .map(s => ({
                  id: s[id],
                  label: s[label],
                  lat: s[lat],
                  lon: s[lon]
                }));
            });
        },

        render() {
          let el = document.getElementById("purple-air-sensors");
          el.innerHTML = "";

          for (let loc in this.sensors)
            if (this.sensors[loc].enabled) this.render_sensor(loc, el);

          document.getElementById(
            "real-time-last-updated"
          ).innerHTML = date_format(new Date(this.last_updated));
        },

        update_sensor_data(sensor_loc, raw_data) {
          let last_sensor_update = new Date();
          let results = raw_data.results;

          let stats = JSON.parse(results[0].Stats);

          this.sensors[sensor_loc].raw_response = raw_data;
          this.sensors[sensor_loc].stats = stats;
          this.sensors[sensor_loc].last_updated = last_sensor_update;

          this.save_cache();
        },

        async fetch_sensor_data(sensor) {
          let query = this.api_url + sensor.id;
          return fetch(query).then(r => r.json());
        },

        render_sensor(loc, el) {
          let id = this.sensors[loc].id;
          let name = this.sensors[loc].label;
          let stats = this.sensors[loc].stats;

          // let div_el = document.getElementById(`${id}-report`);
          // let line_el = div_el.querySelector(".real-time-line");

          let dir = 1;
          let now = stats.v,
            min10 = stats.v1,
            min30 = stats.v2;
          let delta = min10 - now;
          let row_rating = aqi_rating(now * 4);

          let rating_class = row_rating.toLowerCase().replace(/ /g, "-");
          // div_el.classList.add(rating_class);

          // line_el.innerHTML =
          let line_html =
            `${this.format_pm25(now, delta)}` +
            ` | 10min: ${this.format_pm25(min10)}` +
            ` | 30min: ${this.format_pm25(min30)}`;

          el.appendChild(
            this.generate_sensor_line(id, rating_class, name, line_html)
          );
        },

        generate_sensor_line(id, klass, name, line_html) {
          let div = document.createElement("div");
          div.id = `${id}-report`;
          div.classList.add("report-line", "real-time", klass);

          div.innerHTML = `${name}: <span class="real-time-line">${line_html}</span>`;

          return div;
        },

        format_pm25(pm25, dir = 0) {
          let dir_tag = dir > 0 ? "improving" : dir < 0 ? "worsening" : "";

          if (dir_tag) dir_tag = ` <span class="${dir_tag}">${dir_tag}</span>`;

          return `<span class="rating">${Math.round(pm25 * 4)} (${Math.round(
            pm25
          )} PM<sub>2.5</sub>)${dir_tag}</span>`;
        },

        load_from_cache() {
          if (!localStorage.purple_air) return;

          this.sensors = JSON.parse(localStorage.purple_air);
          for (let loc in this.sensors)
            this.sensors[loc].last_updated = new Date(
              this.sensors[loc].last_updated
            );
        },

        save_cache() {
          localStorage.purple_air = JSON.stringify(this.sensors);
        }
      };
      PurpleAir.initialize();
      // PurpleAir.periodic_update();

      var latest = {};
      async function fetch_latest_aq_data() {
        if (window.location.href.startsWith("file")) {
          let cache = localStorage.getItem("cache");
          if (cache) return (latest = JSON.parse(cache));
        }

        for (let loc in ACT_HEALTH_LOCS) {
          let query = AIRRATER_URL.replace(
            "_LAT_",
            ACT_HEALTH_LOCS[loc][0]
          ).replace("_LON_", ACT_HEALTH_LOCS[loc][1]);

          let vals = await fetch(query, { cache: "no-cache" }).then(r =>
            r.json()
          );
          vals.PM25 = vals.PM25.map(parseFloat);
          let l = vals.PM25.length;

          latest[loc] = {
            pm25: vals.PM25[l - 1],
            time: vals.Timestamp.slice(-1)[0],
            improving: vals.PM25[l - 2] > vals.PM25[l - 1],
            raw: vals
          };
        }

        localStorage.setItem("cache", JSON.stringify(latest));

        return latest;
      }

      async function render_current_aq() {
        let latest_data = await fetch_latest_aq_data();

        let last_update = null;

        for (let place in latest_data) {
          if (!COLORS[place]) continue;

          let datum = latest_data[place];
          let pm25 = datum.pm25;
          let aqi = Math.round(pm25 * 4);
          let div_el = document.getElementById(`${place}-report`);
          let span_el = div_el.getElementsByClassName("rating")[0];
          let rating = aqi_rating(aqi);
          let rating_class = rating.toLowerCase().replace(/ /g, "-");
          let delta_class = datum.improving ? "improving" : "worsening";

          div_el.classList.add(rating_class, delta_class);
          span_el.innerHTML = `${rating} - ${aqi} (${pm25} &micro;g/m<sup>3</sup> PM<sub>2.5</sub>)`; // +

          last_update = Math.max(last_update, parse_act_date(datum.time));
        }

        latest_data.last_update = last_update;

        document.getElementById("last-update").innerHTML = date_format(
          new Date(last_update),
          false
        );
        document.getElementById("next-update").innerHTML = date_format(
          new Date(last_update + 60 * 60 * 1000),
          false
        );

        draw_graphs();

        return last_update;
      }

      async function periodic_aq_updates() {
        if (!latest.last_update || latest.last_update < new Date() - AN_HOUR) {
          await render_current_aq();
          setTimeout(periodic_aq_updates, A_MINUTE + Math.random() * 30);
        } else {
          setTimeout(
            periodic_aq_updates,
            latest.last_update + AN_HOUR + Math.random() * 30
          );
        }
      }

      // !!window.chrome && render_current_aq();
      periodic_aq_updates();

      function aqi_rating(aqi) {
        if (aqi >= 200) return "Hazardous";
        else if (aqi >= 150) return "Very Poor";
        else if (aqi >= 100) return "Poor";
        else if (aqi >= 66) return "Fair";
        else if (aqi >= 33) return "Good";
        else if (aqi >= 0) return "Very Good";
        else return "Error";
      }

      const MONTH_NAMES = [
        "January",
        "February",
        "March",
        "April",
        "May",
        "June",
        "July",
        "August",
        "September",
        "October",
        "November",
        "December"
      ];

      function parse_act_date(date) {
        return new Date(date.replace(" ", "T") + "+11:00"); // set to +10:00 for ACT Health data
      }

      function date_format(date, include_daynum = true) {
        let [day, month, dnum, year] = date.toDateString().split(" ");

        let time = date
          .toLocaleTimeString()
          .replace(":00 ", "")
          .toLowerCase();

        return include_daynum
          ? `${day}, ${month} ${dnum} ${time}`
          : `${day} ${time}`;
      }

      function getFormattedDate(
        date,
        prefomattedDate = false,
        hideYear = false
      ) {
        const day = date.getDate();
        const month = MONTH_NAMES[date.getMonth()];
        const year = date.getFullYear();
        const hours = date.getHours();
        let minutes = date.getMinutes();

        if (minutes < 10) {
          // Adding leading zero to minutes
          minutes = `0${minutes}`;
        }

        if (prefomattedDate) {
          // Today at 10:20
          // Yesterday at 10:20
          return `${prefomattedDate} at ${hours}:${minutes}`;
        }

        if (hideYear) {
          // 10. January at 10:20
          return `${day}. ${month} at ${hours}:${minutes}`;
        }

        // 10. January 2017. at 10:20
        return `${day}. ${month} ${year}. at ${hours}:${minutes}`;
      }

      // from: https://muffinman.io/javascript-time-ago-function/
      function timeAgo(dateParam) {
        if (!dateParam) {
          return null;
        }

        const date =
          typeof dateParam === "object" ? dateParam : new Date(dateParam);
        const DAY_IN_MS = 86400000; // 24 * 60 * 60 * 1000
        const today = new Date();
        const yesterday = new Date(today - DAY_IN_MS);
        const seconds = Math.round((today - date) / 1000);
        const minutes = Math.round(seconds / 60);
        const isToday = today.toDateString() === date.toDateString();
        const isYesterday = yesterday.toDateString() === date.toDateString();
        const isThisYear = today.getFullYear() === date.getFullYear();

        if (seconds < 5) {
          return "now";
        } else if (seconds < 60) {
          return `${seconds} seconds ago`;
        } else if (seconds < 90) {
          return "about a minute ago";
        } else if (minutes < 60) {
          return `${minutes} minutes ago`;
        } else if (isToday) {
          return getFormattedDate(date, "Today"); // Today at 10:20
        } else if (isYesterday) {
          return getFormattedDate(date, "Yesterday"); // Yesterday at 10:20
        } else if (isThisYear) {
          return getFormattedDate(date, false, true); // 10. January at 10:20
        }

        return getFormattedDate(date); // 10. January 2017. at 10:20
      }
    </script>

    <script src="https://www.gstatic.com/charts/loader.js"></script>
    <script>
      // These correspond to ACT Health's 7 point scale
      // https://www.health.act.gov.au/about-our-health-system/population-health/environmental-monitoring/monitoring-and-regulating-air-0
      // THRESHOLDS = [
      //   ["Good", 0, "#538135"],
      //   ["Standard", 9, "#2f5496"],
      //   ["Sensitive", 26, "#ffc000"],
      //   ["All", 40, "#ff6600"],
      //   ["Very", 107, "#ff3333"],
      //   ["High", 180, "#bb6528"],
      //   ["Extreme", 250, "#000000"]
      // ];

      // We'll use our standard AQI numbers for now, until the differences are clarified
      THRESHOLDS = [
        ["Very Good", 0, "#3d85c6"],
        ["Good", 34 / 4, "#274e13"],
        ["Fair", 67 / 4, "#f1c232"],
        ["Poor", 100 / 4, "#e59137"],
        ["Very Poor", 150 / 4, "#a64d79"],
        ["Hazardous", 200 / 4, "#ff0000"]
      ];

      LOC_COLORS = {
        Civic: "#636363",
        Florey: "#f8b2b8",
        Monash: "#71abd9"
      };

      GRAPH_HOUR_RANGE = 6; // hours: controls data range generated for graph

      THRESHOLD_SERIES = {};
      thresh_start_ind = 3;

      THRESHOLDS.forEach(r => {
        THRESHOLD_SERIES[thresh_start_ind++] = {
          visibleInLegend: false,
          enableInteractivity: false,
          // tooltip: "none",
          lineDashStyle: [5, 5],
          color: r[2]
        };
      });

      function generate_graph_tooltip(val) {
        let rating = aqi_rating(val * 4);
        let rating_class = rating.toLowerCase().replace(/ /g, "-");

        return `${val} - <span class="rating ${rating_class}">${rating}</span>`;
      }

      function generate_graph_data(offset, range) {
        let aqi_data = latest;

        let raw_pm25 = ["Civic", "Florey", "Monash"].map(l =>
          aqi_data[l].raw.PM25.map(parseFloat).slice(
            offset,
            range && offset + range
          )
        );

        let max = Math.max(...raw_pm25.map(l => Math.max(...l)));

        let threshold_ranges = [];
        THRESHOLDS.some(t => {
          threshold_ranges.push(t[1], "");

          if (t[1] > max) return true; // break
        });

        let data = aqi_data.Civic.raw.Timestamp.slice(
          offset,
          range && offset + range
        ).map((n, i) =>
          [
            parse_act_date(n),
            raw_pm25[0][i], // Civic
            generate_graph_tooltip(raw_pm25[0][i]),
            raw_pm25[1][i], // Florey
            generate_graph_tooltip(raw_pm25[1][i]),
            raw_pm25[2][i], // Monash
            generate_graph_tooltip(raw_pm25[2][i])
          ].concat(threshold_ranges)
        );

        return [data, threshold_ranges, max];
      }

      function drawAQI() {
        data = new google.visualization.DataTable();
        data.addColumn("datetime", "Time");
        data.addColumn("number", "Civic");
        data.addColumn({ type: "string", role: "tooltip", p: { html: true } });
        data.addColumn("number", "Florey");
        data.addColumn({ type: "string", role: "tooltip", p: { html: true } });
        data.addColumn("number", "Monash");
        data.addColumn({ type: "string", role: "tooltip", p: { html: true } });

        let [aqi_data, ranges, max_pm25] = generate_graph_data(
          24 - GRAPH_HOUR_RANGE,
          GRAPH_HOUR_RANGE
        );

        for (let i = 0; i < ranges.length; i += 2) {
          data.addColumn("number", ranges[i]);
          data.addColumn({ type: "string", role: "tooltip" });
        }

        data.addRows(aqi_data);

        data_series = {
          0: { color: LOC_COLORS.Civic },
          1: { color: LOC_COLORS.Florey },
          2: { color: LOC_COLORS.Monash }
        };

        let date_title = `${date_format(aqi_data[0][0], false)} - ${date_format(
          aqi_data.slice(-1)[0][0],
          false
        )}`;

        options = {
          title: "PM2.5: " + date_title,
          seriesType: "line",
          focusTarget: "category",
          legend: { position: "top" },
          series: Object.assign(data_series, THRESHOLD_SERIES),
          chartArea: {
            width: "95%",
            left: 40
          },
          vAxis: {
            title: "PM2.5 μm/m³"
          },
          tooltip: { isHtml: true }
        };

        // limit chart height to next higher cutoff range
        let max_threshold = ranges.slice(-2, -1)[0];

        if (max_threshold > max_pm25)
          options.vAxis.viewWindow = { max: max_threshold + 1 };

        chart = new google.visualization.LineChart(
          document.getElementById("chart-div")
        );

        chart.draw(data, options);
      }

      function graphHours(hours_back, link) {
        GRAPH_HOUR_RANGE = hours_back;
        drawAQI();

        document
          .querySelector(".graph-selected")
          .classList.remove("graph-selected");
        link.classList.add("graph-selected");

        return false;
      }

      // Load the Visualization API and the corechart package.
      google.charts.load("current", { packages: ["corechart"] });

      // Set a callback to run when the Google Visualization API is loaded.
      google.charts.setOnLoadCallback(() => {
        GOOGLE_LOADED = true;
      });

      window.addEventListener(
        "resize",
        () => GOOGLE_LOADED && drawAQI(),
        false
      );
    </script>

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=UA-154785385-1"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());

      gtag("config", "UA-154785385-1");
    </script>
  </body>
</html>
